import glob
import os
from segmentation import parse_filename, load_tif, segment_and_measure_spots, store_measurements_in_sql

image_folder = "/Users/hydrablaster/Desktop/Otegui_lab/confocal_images/20X-mchH2Bxistl345-2-seedling1-transzone_overview"
db_path = "results.db"  

def process_images():
    tif_files = glob.glob(os.path.join(image_folder, "*.tif"))
    if not tif_files:
        print("No TIF files found in the specified folder.")
        return

    print(f"Found {len(tif_files)} TIF files.")
    
    for fname in tif_files:
        print(f"Processing: {fname}")
        try:
            meta = parse_filename(os.path.basename(fname))

            img = load_tif(fname)

            spots = segment_and_measure_spots(img, min_area=5)

            store_measurements_in_sql(db_path, meta, spots)

            print(f"{fname} - {len(spots)} spots detected and stored.")

        except Exception as e:
            print(f"Error processing {fname}: {e}")

    print("All images processed successfully!")

if __name__ == "__main__":
    process_images()
